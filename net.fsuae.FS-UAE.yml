app-id: net.fsuae.FS-UAE
branch: stable
command: fs-uae
runtime: org.kde.Platform
runtime-version: '5.15-24.08'
sdk: org.kde.Sdk
base: com.riverbankcomputing.PyQt.BaseApp
base-version: '5.15-24.08'
cleanup-commands:
  - /app/cleanup-BaseApp.sh
build-options:
  env:
    - BASEAPP_REMOVE_WEBENGINE=1
rename-desktop-file: fs-uae.desktop
rename-mime-file: fs-uae.xml
rename-icon: fs-uae
finish-args:
  - --device=all
  - --filesystem=home
  - --share=ipc
  - --share=network
  - --socket=pulseaudio
  - --socket=x11
modules:
  - name: libmpeg2
    config-opts:
      - --disable-static
    rm-configure: true
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /lib/*.la
    sources:
      - type: archive
        url: http://libmpeg2.sourceforge.net/files/libmpeg2-0.5.1.tar.gz
        sha256: dee22e893cb5fc2b2b6ebd60b88478ab8556cb3b93f9a0d7ce8f3b61851871d4
      - type: script
        dest-filename: autogen.sh
        commands:
          - cp -p /usr/share/automake-*/config.{subguess} .
          - autoreconf -vfi

  - name: fs-uae
    build-options:
      arch:
        aarch64:
          config-opts:
            - --disable-jit
    no-autogen: true
    post-install:
      - desktop-file-edit --set-key=NoDisplay --set-value=false /app/share/applications/fs-uae.desktop
    cleanup:
      - /share/man
      - /share/doc
    sources:
      - type: archive
        url: https://fs-uae.net/files/FS-UAE/Stable/3.1.66/fs-uae-3.1.66.tar.xz
        sha256: 606e1868b500413d69bd33bb469f8fd08d6c08988801f17b7dd022f3fbe23832
      - type: patch
        path: fs-uae-install.patch
      - type: shell
        commands:
          - autoreconf -vfi

  - name: fs-uae-launcher
    make-install-args:
      - DESTDIR=/app
    no-autogen: true
    post-install:
      - cp -a /app/share/runtime/applications /app/share/runtime/icons /app/share/
      - mv /app/share/applications/fs-uae-launcher.desktop /app/share/applications/${FLATPAK_ID}.Launcher.desktop
      - mv /app/share/icons/hicolor/64x64/apps/fs-uae-launcher.png /app/share/icons/hicolor/64x64/apps/${FLATPAK_ID}.Launcher.png
      - mv /app/share/icons/hicolor/128x128/apps/fs-uae-launcher.png /app/share/icons/hicolor/128x128/apps/${FLATPAK_ID}.Launcher.png
      - desktop-file-edit --set-icon=net.fsuae.FS-UAE.Launcher /app/share/applications/${FLATPAK_ID}.Launcher.desktop
      - install -D -m644 -t /app/share/appdata/ ${FLATPAK_ID}.appdata.xml
    sources:
      - type: archive
        url: https://fs-uae.net/files/FS-UAE-Launcher/Stable/3.1.66/fs-uae-launcher-3.1.66.tar.xz
        sha256: 47f09069e5b474c0295e989e13edef0eb76c5982fdefd96ec62e0b5363a08ebe
      - type: file
        path: net.fsuae.FS-UAE.appdata.xml
      - type: shell
        commands:
          - sed 's/prefix := .*/prefix := /g' -i ./Makefile
          - sed 's/cp -a share\/\* $(DESTDIR)$(prefix)\/share/cp -fa share\/\* $(DESTDIR)$(prefix)\/share\/runtime/g' -i ./Makefile
    modules:
      - name: certifi
        buildsystem: simple
        build-commands:
          - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
            --prefix=${FLATPAK_DEST} "certifi==2022.6.15" --no-build-isolation
        sources:
          - &id001
            type: file
            url: https://files.pythonhosted.org/packages/e9/06/d3d367b7af6305b16f0d28ae2aaeb86154fa91f144f036c2d5002a5a202b/certifi-2022.6.15-py3-none-any.whl
            sha256: fe86415d55e84719d75f8b69414f6438ac3547d2078ab91b67e779ef69378412

      - name: charset-normalizer
        buildsystem: simple
        build-commands:
          - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
            --prefix=${FLATPAK_DEST} "charset-normalizer==2.1.0" --no-build-isolation
        sources:
          - &id002
            type: file
            url: https://files.pythonhosted.org/packages/94/69/64b11e8c2fb21f08634468caef885112e682b0ebe2908e74d3616eb1c113/charset_normalizer-2.1.0-py3-none-any.whl
            sha256: 5189b6f22b01957427f35b6a08d9a0bc45b46d3788ef5a92e978433c7a35f8a5

      - name: idna
        buildsystem: simple
        build-commands:
          - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
            --prefix=${FLATPAK_DEST} "idna==3.3" --no-build-isolation
        sources:
          - &id003
            type: file
            url: https://files.pythonhosted.org/packages/04/a2/d918dcd22354d8958fe113e1a3630137e0fc8b44859ade3063982eacd2a4/idna-3.3-py3-none-any.whl
            sha256: 84d9dd047ffa80596e0f246e2eab0b391788b0503584e8945f2368256d2735ff

      - name: requests
        buildsystem: simple
        build-commands:
          - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
            --prefix=${FLATPAK_DEST} "requests==2.28.1" --no-build-isolation
        sources:
          - *id001
          - *id002
          - *id003
          - type: file
            url: https://files.pythonhosted.org/packages/ca/91/6d9b8ccacd0412c08820f72cebaa4f0c0441b5cda699c90f618b6f8a1b42/requests-2.28.1-py3-none-any.whl
            sha256: 8fefa2a1a1365bf5520aac41836fbee479da67864514bdb821f31ce07ce65349
          - &id004
            type: file
            url: https://files.pythonhosted.org/packages/d1/cb/4783c8f1a90f89e260dbf72ebbcf25931f3a28f8f80e2e90f8a589941b19/urllib3-1.26.11-py2.py3-none-any.whl
            sha256: c33ccba33c819596124764c23a97d25f32b28433ba0dedeb77d873a38722c9bc

      - name: lhafile
        buildsystem: simple
        build-commands:
          - "/usr/bin/pip3 --disable-pip-version-check install --prefix=/app --no-deps --verbose ."
        sources:
          - type: archive
            url: https://github.com/FrodeSolheim/python-lhafile/archive/v0.2.2.tar.gz
            sha256: 18396276b77d8c7e094f169d3b2471e60de3d412a2454a0f73c452a54817ee68

      - name: urllib3
        buildsystem: simple
        build-commands:
          - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
            --prefix=${FLATPAK_DEST} "urllib3==1.26.11" --no-build-isolation
        sources:
          - *id004

      - name: chardet
        buildsystem: simple
        build-commands:
          - "/usr/bin/pip3 --disable-pip-version-check install --prefix=/app --no-deps --verbose ."
        sources:
          - type: archive
            url: https://github.com/chardet/chardet/archive/3.0.4.tar.gz
            sha256: d5620025cfca430f6c2e28ddbc87c3c66a5c82fa65570ae975c92911c2190189
